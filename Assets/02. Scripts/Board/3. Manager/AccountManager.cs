using Firebase;
using Firebase.Extensions;
using Firebase.Auth;
using Firebase.Firestore;
using UnityEngine;
using System.Collections.Generic;
using System;
using System.Threading.Tasks;


public class AccountManager : Singleton<AccountManager>
{
    public event Action OnLoginSuccess;
    public event Action OnLogout;

    private FirebaseAuth _auth => FirebaseInitialize.Auth;

    private Account _myAccount;
    public AccountDTO MyAccount
    {
        get
        {
            if (_myAccount == null)
            {
                throw new InvalidOperationException("현재 로그인된 계정이 없습니다.");
            }
            return _myAccount.ToDto();
        }
    }

    #region Register
    /// <summary>
    /// 회원가입
    /// </summary>
    public async Task<bool> RegisterAsync(string email, string nickname, string password)
    {
        await FirebaseInitialize.WaitForInitializationAsync();

        try
        {
            var result = await _auth.CreateUserWithEmailAndPasswordAsync(email, password);
            await SetInitialNicknameAsync(result.User, nickname);
            Debug.Log($"회원가입 성공 : {result.User.UserId}");
            return true;
        }
        catch (Exception ex)
        {
            Debug.LogError($"회원가입 실패: {ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 회원가입 시 최초 1회 서버의 DisplayName변경용
    /// </summary>
    private async Task SetInitialNicknameAsync(FirebaseUser user, string nickname)
    {
        await FirebaseInitialize.WaitForInitializationAsync();

        if (user == null) return;

        var profile = new UserProfile { DisplayName = nickname };
        await user.UpdateUserProfileAsync(profile);
    }
    #endregion

    #region 로그인/로그아웃
    /// <summary>
    /// 로그인
    /// </summary>
    public async Task<bool> LoginAsync(string email, string password)
    {
        await FirebaseInitialize.WaitForInitializationAsync();

        try
        {
            var result = await _auth.SignInWithEmailAndPasswordAsync(email, password);
            SetMyAccount(result.User);
            Debug.Log($"로그인 성공 : {result.User.DisplayName} ({result.User.UserId})");

            OnLoginSuccess?.Invoke();
            return true;
        }
        catch (Exception ex)
        {
            Debug.LogError($"로그인 실패: {ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 동기로 로그아웃이 더 안정적일 듯 함
    /// </summary>
    public void Logout()
    {
        if (_auth.CurrentUser == null)
        {
            Debug.LogWarning("이미 로그아웃된 상태입니다.");
            return;
        }

        _auth.SignOut();
        SetMyAccount(null);

        Debug.Log("로그아웃 되었습니다.");
        OnLogout?.Invoke();  // UI 갱신 같은 후속처리
    }
    #endregion

    #region Nickname
    /// <summary>
    /// 로그인 후, 자신의 닉네임 변경 용
    /// </summary>
    public async Task<bool> ChangeMyNicknameAsync(string newNickname)
    {
        await FirebaseInitialize.WaitForInitializationAsync();

        var user = _auth.CurrentUser;

        if (user == null)
        {
            Debug.LogWarning("로그인된 유저가 없습니다.");
            return false;
        }

        if (user.Email != _myAccount.Email)
        {
            throw new Exception("유저 정보가 다릅니다");
        }

        var profile = new UserProfile
        {
            DisplayName = newNickname,
        };

        try
        {
            await user.UpdateUserProfileAsync(profile);
            _myAccount.SetNickname(newNickname, out string message);
            Debug.Log($"닉네임이 '{newNickname}'(으)로 변경되었습니다.");
            return true;
        }
        catch (Exception ex)
        {
            Debug.LogError("닉네임 변경 실패: " + ex.Message);
            return false;
        }
    }
    #endregion

    /// <summary>
    /// 내부적으로 가지고 있는 Account 객체 유지용
    /// </summary>
    private void SetMyAccount(FirebaseUser user)
    {
        if (user != null)
        {
            _myAccount = new Account(user.Email, user.DisplayName);
        }
        else
        {
            _myAccount = null;
        }
    }
}